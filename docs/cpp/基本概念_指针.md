# 指针

## stack and heap


![](./imgs/2024-07/JmCGSfOJxRtoijsX.png){width=600px}

Data/BSS (Block Started by Symbol) segments are larger than stack memory (max ≈ 1GB in general) but slower

|  | Stack | Heap |
| :---: | :---: | :---: |
| Memory <br> Organization | Contiguous (LIFO) | Contiguous within an allocation, <br> Fragmented between allocations <br> (relies on virtual memory) |
| Max size | Small (8MB on Linux, 1MB on <br> Windows) | Whole system memory |
| If exceed | Program crash at function <br> entry (hard to debug) | Exception or nullptr |
| Allocation | Compile-time | Run-time |
| Locality | High | Low |
| Thread View | Each thread has its own stack | Shared among threads |

### stack

```cpp
int x = 3; // not on the stack (data segment)
struct A {
int k; // depends on where the instance of A is
};
int main() {
int y = 3; // on stack
char z[] = "abc"; // on stack
A a; // on stack (also k)
void* ptr = malloc(4); // variable "ptr" is on the stack
}
```

* 在 `stack` 上的 data:
	* 局部变量 (local variable)
	* 函数参数 (Function arguments)
	* 编译器临时变量 (Compiler temporaries)
	* 中断上下文 (Interrupt contexts)

注意: **存储在栈 (stack) 中的每个对象在其作用域之外都是无效的！**

```cpp
int* f() {
int array[3] = {1, 2, 3};
return array;
}
int* ptr = f();
cout << ptr[0]; // Illegal memory access!! 
```

```cpp
void g(bool x) {
const char* str = "abc";
if (x) {
char xyz[] = "xyz";
str = xyz;
}
cout << str; // if "x" is true, then Illegal memory access!! 
}
```


### heap

学习堆 (heap) 的用法，关键是掌握 `new` 和 `delete`

`new`/`new[]` 和 `delete`/`delete[]` 是 C++ 的关键字，它们在运行时执行动态内存分配/释放以及对象的构造/析构。

`malloc` 和 `free` 是 C 语言中的函数，它们只负责分配和释放内存块（以字节为单位）, 不涉及调用对象的构造函数和析构函数。同时，`new` 返回确切的数据类型，而 `malloc()` 返回 `void*`


<!--stackedit_data:
eyJoaXN0b3J5IjpbLTExMTQ2MzcwMDEsLTQzODI4MTMwNywxOT
g3MzI4NzExLDEwMDk4MzIzNTUsLTE0OTE3MzUyNTgsLTEwMzgw
OTIxODcsLTE2NDExNDE5MjUsMTY2Mjg3OTE0XX0=
-->